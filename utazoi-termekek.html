<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
<title>K√ºlf√∂ldi v√°s√°rl√°s</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700;800&display=swap');

  :root {
    --ink: #1c1c1c;
    --paper: #f5f5f5;
    --cream: #ebebeb;
    --accent: #2563eb;
    --al: #dbeafe;
    --star: #f59e0b;
    --green: #16a34a;
    --red: #dc2626;
    --muted: #777;
    --bd: #d0d0d0;
    --sh: rgba(0, 0, 0, .08);
    --card: #fff;
    --f: 'DM Sans', sans-serif
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0
  }

  body {
    font-family: var(--f);
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh
  }

  /* ‚îÄ‚îÄ STICKY TOP ‚îÄ‚îÄ */
  #topbar {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--ink);
    box-shadow: 0 2px 8px var(--sh)
  }

  header {
    color: var(--paper);
    padding: 10px 14px;
    display: flex;
    align-items: center;
    gap: 8px
  }

  header h1 {
    font-size: 1.1rem;
    font-weight: 800;
    letter-spacing: -.5px;
    flex: 1;
    white-space: nowrap
  }

  header h1 span {
    color: #93c5fd
  }

  .hbtn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 10px;
    border-radius: 6px;
    border: none;
    font-family: var(--f);
    font-size: .82rem;
    font-weight: 600;
    cursor: pointer;
    transition: .15s
  }

  .hbtn-pr {
    background: var(--accent);
    color: #fff
  }

  .hbtn-pr:hover {
    background: #1d4ed8
  }

  .hbtn-gh {
    background: transparent;
    color: var(--paper);
    border: 1.5px solid rgba(255, 255, 255, .3)
  }

  .hbtn-gh:hover {
    background: rgba(255, 255, 255, .1)
  }

  .hbtn-act {
    background: rgba(255, 255, 255, .2);
    color: #fff
  }

  /* search bar */
  #searchBar {
    background: var(--cream);
    border-bottom: 1px solid var(--bd);
    padding: 8px 12px;
    display: none
  }

  #searchBar.open {
    display: block
  }

  .s-row {
    display: flex;
    gap: 6px;
    margin-bottom: 6px
  }

  .s-inp {
    flex: 1;
    padding: 7px 10px;
    border: 1.5px solid var(--bd);
    border-radius: 8px;
    background: #fff;
    font-family: var(--f);
    font-size: .84rem;
    outline: none;
    transition: .15s
  }

  .s-inp:focus {
    border-color: var(--accent)
  }

  .f-row {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    align-items: center
  }

  .fsel {
    padding: 5px 7px;
    border-radius: 6px;
    border: 1px solid var(--bd);
    background: #fff;
    font-family: var(--f);
    font-size: .76rem;
    color: var(--ink);
    cursor: pointer;
    outline: none
  }

  .fsel:focus {
    border-color: var(--accent)
  }

  .fclear {
    padding: 5px 8px;
    border-radius: 6px;
    border: 1px solid var(--bd);
    background: #fff;
    font-family: var(--f);
    font-size: .76rem;
    color: var(--muted);
    cursor: pointer;
    display: none;
    white-space: nowrap
  }

  .fclear:hover {
    background: var(--cream);
    color: var(--ink)
  }

  #rCount {
    font-size: .7rem;
    color: var(--muted);
    margin-top: 5px;
    font-weight: 500
  }

  /* admin bar */
  #adminBar {
    display: none;
    background: #111;
    color: var(--paper);
    padding: 8px 12px;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
    font-size: .78rem;
    border-bottom: 1px solid #333;
  }

  #adminBar.on {
    display: flex
  }

  .ab {
    background: rgba(255, 255, 255, .15);
    color: #fff;
    padding: 4px 9px;
    border-radius: 6px;
    border: none;
    font-family: var(--f);
    font-size: .76rem;
    font-weight: 600;
    cursor: pointer
  }

  .ab-red {
    background: var(--red)
  }

  .ab-badge {
    background: var(--accent);
    color: #fff;
    font-size: .65rem;
    font-weight: 700;
    padding: 2px 7px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: .5px
  }

  /* grid */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 10px;
    padding: 10px
  }

  .card {
    background: var(--card);
    border: 1px solid var(--bd);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 1px 6px var(--sh);
    transition: .18s;
    display: flex;
    flex-direction: column
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 14px var(--sh)
  }

  .c-img-wrap {
    position: relative;
    width: 100%;
    height: 200px;
    background: var(--cream);
    overflow: hidden;
    flex-shrink: 0
  }

  .c-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: zoom-in;
    display: block;
    transition: .18s
  }

  .card:hover .c-img {
    transform: scale(1.04)
  }

  .c-ph {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: var(--bd);
    cursor: pointer
  }

  .c-cat {
    position: absolute;
    top: 8px;
    left: 8px;
    background: var(--ink);
    color: #fff;
    font-size: .68rem;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 20px;
    pointer-events: none;
    z-index: 2
  }

  .c-body {
    padding: 8px 10px;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
    cursor: pointer
  }

  .c-name {
    font-size: .9rem;
    font-weight: 600;
    line-height: 1.3
  }

  .c-desc {
    font-size: .78rem;
    color: var(--muted);
    line-height: 1.4
  }

  .c-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 4px
  }

  .pill {
    font-size: .7rem;
    padding: 2px 7px;
    border-radius: 20px;
    background: var(--cream);
    color: var(--muted);
    border: 1px solid var(--bd)
  }

  .c-pr-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 4px
  }

  .c-pr {
    font-size: .84rem;
    font-weight: 700
  }

  .pch {
    font-size: .7rem;
    font-weight: 600;
    padding: 2px 7px;
    border-radius: 8px
  }

  .pup {
    background: #fde8e8;
    color: var(--red)
  }

  .pdn {
    background: #e6f5ec;
    color: var(--green)
  }

  .stars {
    color: var(--star);
    font-size: .78rem
  }

  .c-foot {
    padding: 7px 10px;
    border-top: 1px solid var(--bd);
    display: flex;
    gap: 5px;
    justify-content: flex-end
  }

  /* price history compact */
  .ph {
    margin-top: 5px;
    background: var(--cream);
    border-radius: 8px;
    padding: 7px 9px;
    border: 1px solid var(--bd)
  }

  .ph-title {
    font-size: .7rem;
    font-weight: 600;
    color: var(--muted);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: .5px
  }

  .ph-row {
    display: flex;
    align-items: baseline;
    gap: 6px;
    font-size: .77rem;
    padding: 2px 0;
    border-bottom: 1px dashed var(--bd);
    overflow: hidden;
    white-space: nowrap
  }

  .ph-row:last-child {
    border: none
  }

  .ph-d {
    color: var(--muted);
    flex-shrink: 0;
    min-width: 52px
  }

  .ph-v {
    font-weight: 600;
    flex-shrink: 0
  }

  .ph-x {
    color: var(--muted);
    font-size: .71rem;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
    min-width: 0
  }

  /* detail view ‚Äì multiline ok */
  .ph-det {
    display: grid;
    grid-template-columns: 90px auto 1fr;
    gap: 10px;
    font-size: .8rem;
    padding: 3px 0;
    border-bottom: 1px dashed var(--bd);
    align-items: baseline
  }

  .ph-det:last-child {
    border: none
  }

  .ph-det .ph-x {
    white-space: normal;
    overflow: visible;
    text-overflow: unset
  }

  /* gallery */
  .gallery {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden
  }

  .g-track {
    display: flex;
    height: 100%;
    transition: transform .3s ease
  }

  .g-slide {
    min-width: 100%;
    height: 100%;
    flex-shrink: 0;
    position: relative
  }

  .g-dots {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
    pointer-events: none
  }

  .g-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(255, 255, 255, .5);
    transition: .2s
  }

  .g-dot.on {
    background: rgba(255, 255, 255, .95);
    width: 18px;
    border-radius: 3px
  }

  /* lightbox */
  .lb {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 500;
    background: rgba(0, 0, 0, .92);
    align-items: center;
    justify-content: center;
    cursor: zoom-out;
    padding: 16px;
    overflow: hidden
  }

  .lb.on {
    display: flex
  }

  .lb img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 6px;
    cursor: default;
    animation: lbIn .18s ease;
    touch-action: none
  }

  @keyframes lbIn {
    from {
      transform: scale(.92);
      opacity: 0
    }

    to {
      transform: scale(1);
      opacity: 1
    }
  }

  .lb-x {
    position: absolute;
    top: 14px;
    right: 18px;
    color: #fff;
    font-size: 2rem;
    cursor: pointer;
    background: none;
    border: none;
    opacity: .7
  }

  .lb-x:hover {
    opacity: 1
  }

  /* overlay/modal */
  .ov {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, .5);
    z-index: 200;
    align-items: flex-end;
    justify-content: center
  }

  .ov.on {
    display: flex
  }

  .modal {
    background: var(--card);
    border-radius: 14px 14px 0 0;
    width: 100%;
    max-width: 520px;
    max-height: 92vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 -4px 30px rgba(0, 0, 0, .2);
    animation: up .2s ease
  }

  @keyframes up {
    from {
      transform: translateY(40px);
      opacity: 0
    }

    to {
      transform: translateY(0);
      opacity: 1
    }
  }

  .mh {
    padding: 12px 16px 10px;
    border-bottom: 1px solid var(--bd);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0
  }

  .mt {
    font-size: 1rem;
    font-weight: 700
  }

  .mx {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    color: var(--muted);
    padding: 3px 7px;
    border-radius: 5px
  }

  .mx:hover {
    background: var(--cream);
    color: var(--ink)
  }

  .mb {
    padding: 14px 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto;
    flex: 1
  }

  .mf {
    padding: 10px 16px;
    border-top: 1px solid var(--bd);
    display: flex;
    gap: 7px;
    justify-content: flex-end;
    flex-shrink: 0
  }

  /* forms */
  .fg {
    display: flex;
    flex-direction: column;
    gap: 4px
  }

  .fl {
    font-size: .73rem;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: .4px
  }

  .fi,
  .fsel2,
  .fta {
    padding: 8px 11px;
    border: 1.5px solid var(--bd);
    border-radius: 7px;
    background: #fff;
    font-family: var(--f);
    font-size: .84rem;
    color: var(--ink);
    outline: none;
    transition: .15s
  }

  .fi:focus,
  .fsel2:focus,
  .fta:focus {
    border-color: var(--accent)
  }

  .fta {
    resize: vertical;
    min-height: 58px
  }

  .frow {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px
  }

  .fhint {
    font-size: .71rem;
    color: var(--muted)
  }

  /* stars */
  .sp {
    display: flex;
    gap: 4px
  }

  .sb {
    background: none;
    border: none;
    font-size: 1.9rem;
    cursor: pointer;
    transition: .12s;
    color: #d0d0d0;
    padding: 0;
    line-height: 1
  }

  .sb.on {
    color: var(--star)
  }

  .sb:hover {
    transform: scale(1.2);
    color: var(--star)
  }

  /* img upload */
  .iu {
    border: 2px dashed var(--bd);
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    cursor: pointer;
    transition: .15s;
    background: var(--cream)
  }

  .iu:hover {
    border-color: var(--accent);
    background: #f0f4ff
  }

  .iu input {
    display: none
  }

  .ip {
    max-height: 100px;
    border-radius: 6px;
    max-width: 100%;
    margin-top: 6px
  }

  /* tags */
  .tw {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    align-items: center;
    padding: 6px 8px;
    border: 1.5px solid var(--bd);
    border-radius: 7px;
    background: #fff;
    min-height: 38px;
    cursor: text;
    transition: .15s
  }

  .tw:focus-within {
    border-color: var(--accent)
  }

  .ti {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: var(--al);
    color: var(--accent);
    border: 1px solid #bfdbfe;
    border-radius: 20px;
    font-size: .78rem;
    font-weight: 600;
    padding: 2px 8px 2px 10px
  }

  .ti button {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--accent);
    font-size: .9rem;
    line-height: 1;
    opacity: .7
  }

  .ti button:hover {
    opacity: 1
  }

  .tin {
    border: none;
    outline: none;
    font-family: var(--f);
    font-size: .84rem;
    background: transparent;
    min-width: 100px;
    flex: 1
  }

  /* cat drag list */
  .cl {
    display: flex;
    flex-direction: column;
    gap: 6px
  }

  .ci {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--cream);
    border-radius: 8px;
    border: 1px solid var(--bd);
    transition: .15s
  }

  .ci[draggable] {
    cursor: grab
  }

  .ci[draggable]:active {
    cursor: grabbing
  }

  .ci.do {
    box-shadow: 0 0 0 2px var(--accent);
    background: var(--al)
  }

  .ci.drag {
    opacity: .4
  }

  .dh {
    color: var(--bd);
    font-size: 1rem;
    cursor: grab;
    padding: 0 4px 0 0;
    user-select: none;
    flex-shrink: 0
  }

  .dh:hover {
    color: var(--muted)
  }

  .cn {
    font-size: .88rem;
    font-weight: 500;
    flex: 1
  }

  /* btns */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 7px 12px;
    border-radius: 6px;
    border: none;
    font-family: var(--f);
    font-size: .84rem;
    font-weight: 600;
    cursor: pointer;
    transition: .15s
  }

  .bp {
    background: var(--accent);
    color: #fff
  }

  .bp:hover {
    background: #1d4ed8
  }

  .bg {
    background: var(--cream);
    color: var(--ink)
  }

  .bg:hover {
    background: #ddd
  }

  .br {
    background: var(--red);
    color: #fff
  }

  .br:hover {
    background: #b91c1c
  }

  .bi {
    padding: 5px;
    border-radius: 6px;
    background: var(--cream);
    border: 1px solid var(--bd);
    color: var(--ink);
    cursor: pointer;
    font-size: .84rem;
    transition: .15s
  }

  .bi:hover {
    background: #ddd
  }

  .bsm {
    padding: 4px 8px;
    font-size: .76rem
  }

  /* toast */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 999;
    background: var(--ink);
    color: var(--paper);
    padding: 11px 16px;
    border-radius: 10px;
    font-size: .84rem;
    font-weight: 500;
    box-shadow: 0 6px 20px rgba(0, 0, 0, .3);
    transform: translateY(80px);
    opacity: 0;
    transition: .25s;
    max-width: 270px
  }

  .toast.on {
    transform: translateY(0);
    opacity: 1
  }

  .toast.ok {
    border-left: 4px solid var(--green)
  }

  .toast.err {
    border-left: 4px solid var(--red)
  }

  /* loading */
  #lb2 {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 300;
    background: var(--accent);
    color: #fff;
    padding: 5px 14px;
    font-size: .8rem;
    font-weight: 600;
    align-items: center;
    gap: 8px
  }

  .spin {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid rgba(255, 255, 255, .4);
    border-top-color: #fff;
    border-radius: 50%;
    animation: sp .7s linear infinite;
    flex-shrink: 0
  }

  @keyframes sp {
    to {
      transform: rotate(360deg)
    }
  }

  /* scroll to top (mobile) */
  #stt {
    display: none;
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--ink);
    color: #fff;
    border: none;
    border-radius: 20px;
    padding: 8px 16px;
    font-family: var(--f);
    font-size: .8rem;
    font-weight: 600;
    cursor: pointer;
    z-index: 90;
    box-shadow: 0 4px 14px rgba(0, 0, 0, .25);
    transition: .2s;
    opacity: 0
  }

  #stt.on {
    opacity: 1
  }

  @media(max-width:500px) {
    #stt {
      display: block
    }
  }

  /* empty */
  .empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
    grid-column: 1/-1
  }

  .empty-ico {
    font-size: 3.5rem;
    margin-bottom: 12px
  }

  /* details */
  details summary {
    cursor: pointer;
    font-size: .78rem;
    color: var(--muted);
    font-weight: 600;
    user-select: none
  }

  details summary:hover {
    color: var(--ink)
  }

  @media(max-width:500px) {
    .grid {
      grid-template-columns: 1fr;
      padding: 8px;
      gap: 8px
    }

    .frow {
      grid-template-columns: 1fr
    }

    header h1 {
      font-size: .95rem
    }

    .modal {
      max-height: 100vh;
      height: 100vh;
      border-radius: 0
    }

    .ov {
      align-items: flex-start
    }

    #mView .modal {
      display: flex;
      flex-direction: column
    }

    /* STICKY HEADER - term√©k n√©v mindig l√°that√≥ */
    #mView .mh {
      position: sticky;
      top: 0;
      z-index: 20;
      background: var(--card);
      box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
    }

    #mView .mb {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 20px
    }

    #mView .mf {
      position: sticky;
      bottom: 0;
      background: var(--card);
      z-index: 20;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, .1);
      padding: 10px 16px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom))
    }

    #stt {
      display: block
    }
  }

  @media(min-width:501px) {
    .ov {
      align-items: center;
      padding: 12px
    }

    .modal {
      border-radius: 12px;
      max-height: 90vh
    }

    #stt {
      display: none !important
    }

    /* Egyedi scrollbar */
    .mb::-webkit-scrollbar {
      width: 8px;
    }

    .mb::-webkit-scrollbar-track {
      background: var(--cream);
      border-radius: 4px;
    }

    .mb::-webkit-scrollbar-thumb {
      background: var(--bd);
      border-radius: 4px;
    }

    .mb::-webkit-scrollbar-thumb:hover {
      background: var(--muted);
    }

    /* Firefox */
    .mb {
      scrollbar-width: thin;
      scrollbar-color: var(--bd) var(--cream);
    }
  }
</style>
</head>
<body>

<div id="lb2">
  <span class="spin"></span>
  <span id="lbMsg">Ment√©s...</span>
</div>

<!-- STICKY TOP BAR -->
<div id="topbar">
  <header>
    <h1>K√ºlf√∂ldi <span>v√°s√°rl√°s</span></h1>
    <button class="hbtn hbtn-gh" id="btnSearch" title="Keres√©s / Sz≈±r≈ëk" onclick="toggleSearch()">üîç</button>
    <button class="hbtn hbtn-pr" id="btnAdd">+ Term√©k</button>
    <button class="hbtn hbtn-gh" id="btnAdmin" title="Admin" onclick="adminClick()">‚öô</button>
  </header>
  <div id="adminBar">
    <span class="ab-badge">Admin</span>
    <button class="ab" id="btnCats">Kateg√≥ri√°k</button>
    <button class="ab" id="btnCurrs">P√©nznemek</button>
    <button class="ab" id="btnCnts">Orsz√°gok</button>
    <button class="ab" id="btnShps">Boltok</button>
    <button class="ab" id="btnSheets">üîó Sheets</button>
    <button class="ab" id="btnBak">üíæ Backup</button>
    <button class="ab" onclick="exportCSV()">üìä Export</button>
    <button class="ab ab-red" id="btnLogout">Kil√©p</button>
  </div>

  <div id="searchBar">
    <div class="s-row">
      <input class="s-inp" id="sInp" placeholder="Keres√©s n√©v, megjegyz√©s, hely..." oninput="filter()">
      <button class="hbtn hbtn-gh" style="white-space:nowrap;font-size:.76rem" onclick="toggleSearch()">‚úï Z√°r</button>
    </div>
    <div class="f-row">
      <select class="fsel" id="fCat" onchange="filter()"><option value="">Minden kateg√≥ria</option></select>
      <select class="fsel" id="fCnt" onchange="filter()"><option value="">Minden orsz√°g</option></select>
      <select class="fsel" id="fShp" onchange="filter()"><option value="">Minden bolt</option></select>
      <select class="fsel" id="fCur" onchange="filter()"><option value="">Minden p√©nznem</option></select>
      <button class="fclear" id="btnCF" onclick="clearF()">‚úï T√∂rl√©s</button>
    </div>
    <div id="rCount"></div>
  </div>
  
</div>

<div class="grid" id="grid"></div>

<!-- scroll to top -->
<button id="stt" onclick="window.scrollTo({top:0,behavior:'smooth'})">‚Üë Tetej√©re</button>

<!-- ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ -->

<!-- Product modal -->
<div class="ov" id="mProd">
  <div class="modal">
    <div class="mh"><span class="mt" id="mProdT">√öj term√©k</span><button class="mx" onclick="closeM('mProd')">‚úï</button></div>
    <div class="mb">
      <div class="fg">
        <label class="fl">Fot√≥</label>
        <label class="iu" id="iuArea" for="iuFile">
          <div id="iuIco">üì∑</div>
          <div id="iuTxt" style="font-size:.78rem;color:var(--muted)">Koppints a k√©p kiv√°laszt√°s√°hoz</div>
          <img class="ip" id="iuPrev" style="display:none">
        </label>
        <input type="file" id="iuFile" accept="image/*" onchange="handleImg(event)">
      </div>
      <div class="fg"><label class="fl">Term√©k neve *</label><input class="fi" id="fN" placeholder="pl. Nutella 400g" onkeydown="pEnter(event)"></div>
      <div class="fg"><label class="fl">R√∂vid le√≠r√°s</label><input class="fi" id="fD" placeholder="pl. Mogyor√≥s csokol√°d√©kr√©m" onkeydown="pEnter(event)"></div>
      <div class="fg"><label class="fl">Kateg√≥ria</label><select class="fsel2" id="fCatS"><option value="">V√°lassz...</option></select></div>
      <div class="fg">
        <label class="fl">Orsz√°g / Orsz√°gok</label>
        <div class="tw" id="cntWrap"><div id="cntTags"></div><input class="tin" id="fCntI" placeholder="+ Orsz√°g" list="cntList" autocomplete="off" onkeydown="tagKey(event,'c')"></div>
        <datalist id="cntList"></datalist>
      </div>
      <div class="fg">
        <label class="fl">Bolt / Boltok</label>
        <div class="tw" id="shpWrap"><div id="shpTags"></div><input class="tin" id="fShpI" placeholder="+ Bolt" list="shpList" autocomplete="off" onkeydown="tagKey(event,'s')"></div>
        <datalist id="shpList"></datalist>
      </div>
      <div class="fg"><label class="fl">D√°tum</label><input class="fi" type="date" id="fDt"></div>
      <div class="fg">
        <label class="fl">√År √©s p√©nznem</label>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:8px">
          <input class="fi" id="fP" type="number" placeholder="√ñsszeg" min="0" step="any" onkeydown="pEnter(event)">
          <select class="fsel2" id="fCurS"><option value="">P√©nznem</option></select>
        </div>
        <input class="fi" id="fPN" placeholder='Megjegyz√©s az √°rhoz' style="margin-top:6px" onkeydown="pEnter(event)">
        <div class="fhint" style="margin-top:3px">Az √°r r√∂gz√≠t√©sre ker√ºl, k√©s≈ëbb friss√≠thet≈ë.</div>
      </div>
      <div class="fg" style="background:#f0f4ff;border:2px solid var(--accent);border-radius:10px;padding:12px 14px">
        <label class="fl" style="color:var(--accent)">√ârt√©kel√©s</label>
        <div class="sp" id="sp"><button class="sb" onclick="setR(1)">‚òÖ</button><button class="sb" onclick="setR(2)">‚òÖ</button><button class="sb" onclick="setR(3)">‚òÖ</button><button class="sb" onclick="setR(4)">‚òÖ</button><button class="sb" onclick="setR(5)">‚òÖ</button></div>
        <div id="rLbl" style="font-size:.77rem;color:var(--muted);margin-top:3px">Koppints egy csillagra</div>
      </div>
      <div class="fg"><label class="fl">Megjegyz√©s</label><textarea class="fta" id="fNt" placeholder="Tapasztalat..." onkeydown="pEnterTA(event)"></textarea></div>
      <input type="hidden" id="fUp">
    </div>
    <div class="mf">
      <button class="btn bg" onclick="closeM('mProd')">M√©gse</button>
      <button class="btn bp" onclick="saveProd()">Ment√©s</button>
    </div>
  </div>
</div>

<!-- Price modal -->
<div class="ov" id="mPrice">
  <div class="modal" style="max-width:380px">
    <div class="mh"><span class="mt">√År friss√≠t√©se</span><button class="mx" onclick="closeM('mPrice')">‚úï</button></div>
    <div class="mb">
      <div class="fg">
        <label class="fl">√öj √°r</label>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:8px">
          <input class="fi" id="pP" type="number" placeholder="√ñsszeg" min="0" step="any" onkeydown="eS(event,savePr)">
          <select class="fsel2" id="pC"></select>
        </div>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">Orsz√°g</label><input class="fi" id="pCnt" placeholder="pl. Olaszorsz√°g" list="cntList" autocomplete="off" onkeydown="eS(event,savePr)"></div>
        <div class="fg"><label class="fl">Bolt</label><input class="fi" id="pShp" placeholder="pl. Spar" list="shpList" autocomplete="off" onkeydown="eS(event,savePr)"></div>
      </div>
      <div class="fg"><label class="fl">Megjegyz√©s</label><input class="fi" id="pNote" placeholder='pl. "akci√≥"' onkeydown="eS(event,savePr)"></div>
      <div class="fg"><label class="fl">D√°tum</label><input class="fi" type="date" id="pDt" onkeydown="eS(event,savePr)"></div>
    </div>
    <div class="mf"><button class="btn bg" onclick="closeM('mPrice')">M√©gse</button><button class="btn bp" onclick="savePr()">Friss√≠t√©s</button></div>
  </div>
</div>

<!-- Login modal -->
<div class="ov" id="mLogin">
  <div class="modal" style="max-width:340px">
    <div class="mh"><span class="mt">‚öô Admin bel√©p√©s</span><button class="mx" onclick="closeM('mLogin')">‚úï</button></div>
    <div class="mb">
      <div class="fg"><label class="fl">Jelsz√≥</label><input class="fi" type="password" id="aPw" placeholder="Admin jelsz√≥" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <div id="aErr" style="color:var(--red);font-size:.82rem;display:none">Helytelen jelsz√≥!</div>
    </div>
    <div class="mf"><button class="btn bp" onclick="doLogin()">Bel√©p√©s</button></div>
  </div>
</div>

<!-- Cats modal -->
<div class="ov" id="mCats">
  <div class="modal" style="max-width:400px">
    <div class="mh"><span class="mt">üìÇ Kateg√≥ri√°k</span><button class="mx" onclick="closeM('mCats')">‚úï</button></div>
    <div class="mb">
      <div class="cl" id="catList"></div>
      <hr style="border:none;border-top:1px solid var(--bd);margin:8px 0">
      <div class="fg"><label class="fl">√öj kateg√≥ria</label>
        <div style="display:flex;gap:8px"><input class="fi" id="newCat" placeholder="pl. Csokol√°d√©" onkeydown="if(event.key==='Enter')addCat()"><button class="btn bp" onclick="addCat()">+ Hozz√°ad</button></div>
      </div>
    </div>
  </div>
</div>

<!-- Currencies modal -->
<div class="ov" id="mCurrs">
  <div class="modal" style="max-width:400px">
    <div class="mh"><span class="mt">üí± P√©nznemek</span><button class="mx" onclick="closeM('mCurrs')">‚úï</button></div>
    <div class="mb">
      <div class="cl" id="currList"></div>
      <hr style="border:none;border-top:1px solid var(--bd);margin:8px 0">
      <div class="fg"><label class="fl">√öj (k√≥d + n√©v)</label>
        <div style="display:flex;gap:6px">
          <input class="fi" id="nCC" placeholder="GBP" style="max-width:80px">
          <input class="fi" id="nCN" placeholder="Brit font" style="flex:1">
          <button class="btn bp" onclick="addCurr()">+</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Countries modal -->
<div class="ov" id="mCnts">
  <div class="modal" style="max-width:420px">
    <div class="mh"><span class="mt">üåç Orsz√°gok</span><button class="mx" onclick="closeM('mCnts')">‚úï</button></div>
    <div class="mb"><div class="fhint" style="margin-bottom:6px">Kattints a szerkeszt√©shez ‚Äì minden term√©kn√©l friss√ºl.</div><div class="cl" id="cntList"></div></div>
  </div>
</div>

<!-- Shops modal -->
<div class="ov" id="mShps">
  <div class="modal" style="max-width:420px">
    <div class="mh"><span class="mt">üè™ Boltok</span><button class="mx" onclick="closeM('mShps')">‚úï</button></div>
    <div class="mb"><div class="fhint" style="margin-bottom:6px">Kattints a szerkeszt√©shez ‚Äì minden term√©kn√©l friss√ºl.</div><div class="cl" id="shpList2"></div></div>
  </div>
</div>

<!-- View product modal -->
<div class="ov" id="mView">
  <div class="modal" style="max-width:520px">
    <div class="mh"><span class="mt" id="mViewT"></span><button class="mx" onclick="closeM('mView')">‚úï</button></div>
    <div class="mb" id="mViewB"></div>
    <div class="mf" id="mViewF"></div>
  </div>
</div>

<!-- Review modal -->
<div class="ov" id="mRev">
  <div class="modal" style="max-width:380px">
    <div class="mh"><span class="mt">‚úç √ârt√©kel√©s</span><button class="mx" onclick="closeM('mRev')">‚úï</button></div>
    <div class="mb">
      <div class="fg"><label class="fl">Neved</label><input class="fi" id="rN" placeholder="pl. Anna" onkeydown="eS(event,saveRev)"></div>
      <div class="fg" style="background:#f0f4ff;border:2px solid var(--accent);border-radius:10px;padding:12px 14px">
        <label class="fl" style="color:var(--accent)">√ârt√©kel√©s</label>
        <div class="sp" id="sp2"><button class="sb" onclick="setRR(1)">‚òÖ</button><button class="sb" onclick="setRR(2)">‚òÖ</button><button class="sb" onclick="setRR(3)">‚òÖ</button><button class="sb" onclick="setRR(4)">‚òÖ</button><button class="sb" onclick="setRR(5)">‚òÖ</button></div>
        <div id="rLbl2" style="font-size:.77rem;color:var(--muted);margin-top:3px">Koppints egy csillagra</div>
      </div>
      <div class="fg"><label class="fl">Megjegyz√©s</label><textarea class="fta" id="rNote" placeholder="Tapasztalatod..." onkeydown="esSTA(event,saveRev)"></textarea></div>
    </div>
    <div class="mf"><button class="btn bg" onclick="closeM('mRev')">M√©gse</button><button class="btn bp" onclick="saveRev()">Ment√©s</button></div>
  </div>
</div>

<!-- Sheets modal -->
<div class="ov" id="mSheets">
  <div class="modal" style="max-width:470px">
    <div class="mh"><span class="mt">üîó Google Sheets</span><button class="mx" onclick="closeM('mSheets')">‚úï</button></div>
    <div class="mb">
      <div id="shSt" style="padding:9px 13px;border-radius:8px;font-size:.84rem;margin-bottom:4px"></div>
      <div class="fg">
        <label class="fl">Apps Script URL</label>
        <input class="fi" id="shUrl" placeholder="https://script.google.com/macros/s/.../exec" style="font-size:.78rem">
        <div class="fhint" style="margin-top:3px">Illeszd be a Google Apps Script webalkalmaz√°s URL-j√©t.</div>
      </div>
      <details style="margin-top:8px">
        <summary style="color:var(--accent)">üìã Telep√≠t√©si √∫tmutat√≥</summary>
        <div style="font-size:.78rem;color:var(--muted);margin-top:7px;line-height:1.7;background:var(--cream);padding:9px 11px;border-radius:8px">
          1. <a href="https://sheets.google.com" target="_blank" style="color:var(--accent)">sheets.google.com</a> ‚Üí √öj t√°bl√°zat<br>
          2. B≈ëv√≠tm√©nyek ‚Üí Apps Script<br>
          3. M√°sold be az <strong>apps-script.js</strong> tartalm√°t<br>
          4. √územbe helyez√©s ‚Üí Webalkalmaz√°s, Hozz√°f√©r√©s: <strong>B√°rki</strong><br>
          5. M√°sold ki az URL-t √©s illeszd be fentebb
        </div>
      </details>
    </div>
    <div class="mf"><button class="btn bg" onclick="clearSh()">Kapcsolat t√∂rl√©se</button><button class="btn bp" onclick="saveSh()">Ment√©s √©s teszt</button></div>
  </div>
</div>

<!-- Backup modal -->
<div class="ov" id="mBak">
  <div class="modal" style="max-width:480px">
    <div class="mh"><span class="mt">üíæ Backup</span><button class="mx" onclick="closeM('mBak')">‚úï</button></div>
    <div class="mb">
      <div id="bakList" style="display:flex;flex-direction:column;gap:7px"></div>
      <div class="fhint" style="margin-top:10px;padding:9px;background:var(--cream);border-radius:8px">‚ÑπÔ∏è Az utols√≥ 5 v√°ltoztat√°s. Vissza√°ll√≠t√°skor az aktu√°lis adatok fel√ºl√≠r√≥dnak.</div>
    </div>
  </div>
</div>

<!-- Image upload modal -->
<div class="ov" id="mImg">
  <div class="modal" style="max-width:380px">
    <div class="mh"><span class="mt">üì∑ K√©p hozz√°ad√°sa</span><button class="mx" onclick="closeM('mImg')">‚úï</button></div>
    <div class="mb">
      <div style="text-align:center;margin-bottom:10px">
        <label for="qImg" style="display:inline-block;padding:11px 18px;background:var(--accent);color:#fff;border-radius:8px;cursor:pointer;font-weight:600">üì§ K√©p kiv√°laszt√°sa</label>
        <input type="file" id="qImg" accept="image/*" style="display:none" onchange="handleQImg(event)">
      </div>
      <div id="qPrvA" style="display:none;text-align:center">
        <img id="qPrv" style="max-width:100%;max-height:190px;border-radius:8px;margin-bottom:7px">
        <div class="fhint">Kattints a ment√©s gombra</div>
      </div>
    </div>
    <div class="mf"><button class="btn bg" onclick="closeM('mImg')">M√©gse</button><button class="btn bp" id="qSave" onclick="saveQImg()" disabled>Ment√©s</button></div>
  </div>
</div>

<div class="lb" id="lb" onclick="closeLB()">
  <button class="lb-x" onclick="closeLB()">‚úï</button>
  <img id="lbImg" src="" alt="" onclick="event.stopPropagation()">
</div>
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
const ADMIN_PW='admin123';
const SH_DEF='https://script.google.com/macros/s/AKfycbym9Upo6FtNar27q8Y23Fs0lBpeAVbqj11YEZjd5ZDRGUKVWX4CiJ6SYdNb1oBHEtHi/exec';
let shUrl=localStorage.getItem('sheetsApiUrl')||SH_DEF;
let isAdmin=sessionStorage.getItem('isAdmin')==='true';
let prods=[],cats=['Csokol√°d√©','Keksz','√âdess√©gek','Italok','Szeszes italok','F≈±szerek','Kozmetikum','Egy√©b'];
let currs=[{code:'EUR',name:'Eur√≥'},{code:'HUF',name:'Forint'},{code:'USD',name:'Doll√°r'}];
let shpOrd=[],editId=null,rat=0,ratR=0,prId=null,imgPend=null,qImgPid=null,qImgB64=null,revPid=null;
let fCnts=[],fShps=[],gIdx={};

// ‚îÄ‚îÄ ENTER HELPERS ‚îÄ‚îÄ
function eS(e,fn){if(e.key==='Enter'){e.preventDefault();fn();}}
function esSTA(e,fn){if(e.key==='Enter'&&(e.ctrlKey||e.shiftKey)){e.preventDefault();fn();}}
function pEnter(e){if(e.key==='Enter'){e.preventDefault();const n=_('fN').value.trim();if(n)saveProd();}}
function pEnterTA(e){if(e.key==='Enter'&&(e.ctrlKey||e.shiftKey)){e.preventDefault();const n=_('fN').value.trim();if(n)saveProd();}}

// ‚îÄ‚îÄ SHEETS ‚îÄ‚îÄ
async function shGet(act,key){if(!shUrl)return null;const r=await fetch(`${shUrl}?action=${act}${key?'&key='+key:''}`);return r.json();}
async function shWrite(body){try{await fetch(shUrl,{method:'POST',body:JSON.stringify(body),headers:{'Content-Type':'text/plain'}});}catch(e){}}
async function delImgSh(id){if(shUrl)await shWrite({action:'set',key:'img_'+id,value:''});}

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ
function _(id){return document.getElementById(id);}
function setLd(on,msg){_(  'lb2').style.display=on?'flex':'none';if(msg)_('lbMsg').textContent=msg;}
function saveLoc(){localStorage.setItem('products',JSON.stringify(prods));localStorage.setItem('categories',JSON.stringify(cats));localStorage.setItem('currencies',JSON.stringify(currs));localStorage.setItem('shopOrder',JSON.stringify(shpOrd));}

async function loadData(){
  ['products','categories','currencies','shopOrder'].forEach((k,i)=>{
    try{const v=localStorage.getItem(k);if(v){[prods,cats,currs,shpOrd][i]=JSON.parse(v);}}catch(e){}
  });
  if(!shUrl)return;
  setLd(true,'Bet√∂lt√©s...');
  try{
    const d=await shGet('getAll');
    if(d?.ok){
      if(d.products){
        const sp=JSON.parse(d.products),lm=new Map();
        try{JSON.parse(localStorage.getItem('products')||'[]').forEach(p=>{if(p.images?.length)lm.set(p.id,p.images);});}catch(e){}
        prods=sp.map(p=>{
          const li=lm.get(p.id)?.filter(i=>i&&i!=='__img__')||[];
          const ec=p._imgCount||(p.images?.length||0);
          return{...p,image:null,images:li.length===ec&&li.length>0?li:[]};
        });
        prods.forEach(async(p,i)=>{
          if(p.images?.length)return;
          try{
            const rec=[];
            for(let x=0;x<20;x++){const r=await shGet('get',`img_${p.id}_${x}`);if(r?.value)rec.push(r.value);else break;}
            if(!rec.length){const r=await shGet('get','img_'+p.id);if(r?.value)rec.push(r.value);}
            if(rec.length){prods[i]={...prods[i],images:rec,image:null};saveLoc();renderAll();}
          }catch(e){}
        });
      }
      if(d.categories)try{cats=JSON.parse(d.categories);}catch(e){}
      if(d.currencies)try{currs=JSON.parse(d.currencies);}catch(e){}
      if(d.shopOrder)try{shpOrd=JSON.parse(d.shopOrder);}catch(e){}
    }
  }catch(e){toast('Bet√∂lt√©si hiba ‚Äì lok√°lis adatok bet√∂ltve','err');}
  setLd(false);
}

async function save(lite=false){
  mkBak();saveLoc();
  if(!shUrl)return;
  setLd(true,'Ment√©s...');
  try{
    if(lite){
      await shWrite({action:'set',key:'categories',value:JSON.stringify(cats)});
      await shWrite({action:'set',key:'currencies',value:JSON.stringify(currs)});
      await shWrite({action:'set',key:'shopOrder',value:JSON.stringify(shpOrd)});
      setLd(false);return;
    }
    const news=prods.filter(p=>{
      const ni=p.image&&p.image!=='__img__'&&p.image.startsWith('data:');
      const na=p.images?.some(i=>i&&i!=='__img__'&&i.startsWith('data:'));
      return ni||na;
    });
    const psh=prods.map(p=>{const im=imgs(p);return{...p,image:'__img__',images:im.map(()=>'__img__'),_imgCount:im.length};});
    await shWrite({action:'setAll',products:JSON.stringify(psh),categories:JSON.stringify(cats),currencies:JSON.stringify(currs),shopOrder:JSON.stringify(shpOrd)});
    for(const p of news){
      const ai=imgs(p);
      for(let i=0;i<ai.length;i++)if(ai[i]?.startsWith('data:'))await shWrite({action:'set',key:`img_${p.id}_${i}`,value:ai[i]});
      const la=ai[ai.length-1];if(la?.startsWith('data:'))await shWrite({action:'set',key:'img_'+p.id,value:la});
    }
  }catch(e){toast('Ment√©si hiba ‚Äì lok√°lisan mentve','err');}
  setLd(false);
}

async function saveMeta(){
  saveLoc();mkBak();
  if(!shUrl)return;
  const psh=prods.map(p=>{const im=imgs(p);return{...p,image:'__img__',images:im.map(()=>'__img__'),_imgCount:im.length};});
  shWrite({action:'setAll',products:JSON.stringify(psh),categories:JSON.stringify(cats),currencies:JSON.stringify(currs),shopOrder:JSON.stringify(shpOrd)});
}

// ‚îÄ‚îÄ BACKUP ‚îÄ‚îÄ
function mkBak(){try{const pni=prods.map(p=>({...p,image:null,images:[]}));localStorage.setItem('bak_'+Date.now(),JSON.stringify({prods:pni,cats,currs,shpOrd,ts:new Date().toISOString()}));Object.keys(localStorage).filter(k=>k.startsWith('bak_')).sort().reverse().slice(5).forEach(k=>localStorage.removeItem(k));}catch(e){}}
  function getBaks() { return Object.keys(localStorage).filter(k => k.startsWith('bak_')).sort().reverse().map(k => { try { const d = JSON.parse(localStorage.getItem(k)); return { key: k, ts: d.ts, n: d.prods?.length || 0, cats: d.cats?.length || 0, currs: d.currs?.length || 0 }; } catch (e) { return null; } }).filter(Boolean); }
  function renderBakList() {
    const baks = getBaks(), el = _('bakList');
    if (!baks.length) { el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted)">M√©g nincs backup</div>'; return; }
    el.innerHTML = baks.map((b, i) => {
      const ds = new Date(b.ts).toLocaleDateString('hu-HU', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      const label = i === 0 ? '(legfrissebb)' : i === 1 ? '(el≈ëz≈ë)' : '';
      return `<div style="display:flex;align-items:center;gap:10px;padding:11px;background:var(--cream);border-radius:8px">
      <div style="flex:1">
        <div style="font-weight:600;font-size:.84rem">${ds} ${label}</div>
        <div style="font-size:.74rem;color:var(--muted)">${b.n} term√©k ‚Ä¢ ${b.cats || 0} kateg√≥ria ‚Ä¢ ${b.currs || 0} p√©nznem</div>
      </div>
      <button class="btn bp bsm" onclick="restBak('${b.key}')">Vissza√°ll√≠t</button>
    </div>`;
    }).join('');
}
async function restBak(k){
  if(!confirm('Biztosan vissza√°ll√≠tod? Az aktu√°lis adatok elvesznek!'))return;
  try{const b=JSON.parse(localStorage.getItem(k));prods=b.prods||[];cats=b.cats||[];currs=b.currs||[];shpOrd=b.shpOrd||[];await save();renderAll();toast('Backup vissza√°ll√≠tva!');closeM('mBak');}
  catch(e){toast('Vissza√°ll√≠t√°si hiba','err');}
}

// ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ
function renderTags(t){
  const a=t==='c'?fCnts:fShps,id=t==='c'?'cntTags':'shpTags';
  _(id).innerHTML=a.map((v,i)=>`<span class="ti">${esc(v)}<button onclick="rmTag('${t}',${i})">√ó</button></span>`).join('');
}
function rmTag(t,i){(t==='c'?fCnts:fShps).splice(i,1);renderTags(t);}
function addTag(t,v){v=v.trim();if(!v)return;if(t==='c'&&!fCnts.includes(v)){fCnts.push(v);renderTags('c');}if(t==='s'&&!fShps.includes(v)){fShps.push(v);renderTags('s');}}
function tagKey(e,t){if(e.key==='Enter'||e.key===','){e.preventDefault();addTag(t,e.target.value);e.target.value='';}}
function clrTags(){fCnts=[];fShps=[];renderTags('c');renderTags('s');_('fCntI').value='';_('fShpI').value='';}
function setTags(c,s){fCnts=Array.isArray(c)?[...c]:(c?[c]:[]);fShps=Array.isArray(s)?[...s]:(s?[s]:[]);renderTags('c');renderTags('s');_('fCntI').value='';_('fShpI').value='';}
function wireBlur(){['fCntI','fShpI'].forEach(id=>{const el=_(id);if(el)el.addEventListener('blur',()=>{addTag(id==='fCntI'?'c':'s',el.value);el.value='';});});}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
async function init(){
  await loadData();renderAll();updAdmin();
  _('fDt').value=_('pDt').value=new Date().toISOString().split('T')[0];
  updShSt();wireBlur();
  _('btnAdd').onclick=openAddProd;
  _('btnLogout').onclick=()=>{isAdmin=false;sessionStorage.removeItem('isAdmin');updAdmin();toast('Kil√©pve');};
  _('btnCats').onclick=()=>{renderCatList();openM('mCats');};
  _('btnCurrs').onclick=()=>{renderCurrList();openM('mCurrs');};
  _('btnCnts').onclick=()=>{renderCntList();openM('mCnts');};
  _('btnShps').onclick=()=>{renderShpList();openM('mShps');};
  _('btnBak').onclick=()=>{renderBakList();openM('mBak');};
  _('btnSheets').onclick=()=>{_('shUrl').value=shUrl||'';updShSt();openM('mSheets');};

  // scroll to top button
  window.addEventListener('scroll',()=>{
    const btn=_('stt');if(!btn)return;
    btn.classList.toggle('on',window.scrollY>300);
  });
}

// ‚îÄ‚îÄ GALLERY ‚îÄ‚îÄ
function initGallery(){
  document.querySelectorAll('.gallery').forEach(g=>{
    if(g._init)return;g._init=true;
    const tr=g.querySelector('.g-track'),sl=g.querySelectorAll('.g-slide'),dots=g.querySelectorAll('.g-dot');
    if(sl.length<=1)return;
    const pid=g.getAttribute('data-id');
    let ci=gIdx[pid]||0,drag=false,sx=0,st=0;
    const go=n=>{ci=Math.max(0,Math.min(n,sl.length-1));gIdx[pid]=ci;tr.style.transform=`translateX(-${ci*100}%)`;tr.style.transition='transform .3s ease';dots.forEach((d,i)=>d.classList.toggle('on',i===ci));};
    g._go=go;g._ci=()=>ci;go(ci);
    g.addEventListener('touchstart',e=>{drag=true;sx=e.touches[0].pageX;st=-ci*100;tr.style.transition='none';},{passive:true});
    g.addEventListener('touchmove',e=>{if(!drag)return;e.preventDefault();tr.style.transform=`translateX(${st+((e.touches[0].pageX-sx)/g.offsetWidth)*100}%)`;},{passive:false});
    g.addEventListener('touchend',e=>{if(!drag)return;drag=false;const d=e.changedTouches[0].pageX-sx;if(d>50&&ci>0)go(ci-1);else if(d<-50&&ci<sl.length-1)go(ci+1);else go(ci);},{passive:true});
  });
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderAll(){popCatSel();popCurrSel();filter();}

function popCatSel(){
  const o=`<option value="">V√°lassz...</option>`+cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  _('fCatS').innerHTML=o;
  _('fCat').innerHTML=`<option value="">Minden kateg√≥ria</option>`+cats.map(c=>`<option value="${c}">${c}</option>`).join('');
}
function popCurrSel(){
  const o=`<option value="">P√©nznem</option>`+currs.map(c=>`<option value="${c.code}">${c.code} ‚Äì ${c.name}</option>`).join('');
  _('fCurS').innerHTML=o;_('pC').innerHTML=o;
  const used=[...new Set(prods.flatMap(p=>(p.priceHistory?.length?p.priceHistory.map(h=>h.currency):[p.currency]).filter(Boolean)))].sort();
  const kn=new Set(currs.map(c=>c.code));
  _('fCur').innerHTML=`<option value="">Minden p√©nznem</option>`+used.map(c=>`<option value="${c}">${kn.has(c)?c:c+' *'}</option>`).join('');
}

function filter(){
  const q=_('sInp').value.toLowerCase(),cat=_('fCat').value,cnt=_('fCnt').value,shp=_('fShp').value,cur=_('fCur').value;
  const fl=prods.filter(p=>{
    const pc=new Set([...(Array.isArray(p.countries)?p.countries:(p.country?[p.country]:[])), ...(p.priceHistory||[]).map(h=>h.country).filter(Boolean)]);
    const ps=new Set([...(Array.isArray(p.shops)?p.shops:(p.shop?[p.shop]:[])), ...(p.priceHistory||[]).map(h=>h.shop).filter(Boolean)]);
    return(!q||[p.name,p.desc,...ps,...pc,p.note,(p.reviews||[]).map(r=>r.note).join(' ')].join(' ').toLowerCase().includes(q))
      &&(!cat||p.category===cat)&&(!cnt||pc.has(cnt))&&(!shp||ps.has(shp))
      &&(!cur||(p.priceHistory||[{currency:p.currency}]).some(h=>h.currency===cur));
  });
  _('rCount').textContent=`${fl.length} term√©k / √∂sszesen ${prods.length}`;
  renderGrid(fl);updFO();updCF();popDL();
}

function updFO(){
  const cnts=uCnts(),shps=uShps(),cc=_('fCnt').value,cs=_('fShp').value;
  _('fCnt').innerHTML=`<option value="">Minden orsz√°g</option>`+cnts.map(c=>`<option value="${c}"${c===cc?' selected':''}>${c}</option>`).join('');
  _('fShp').innerHTML=`<option value="">Minden bolt</option>`+shps.map(s=>`<option value="${s}"${s===cs?' selected':''}>${s}</option>`).join('');
}

function renderGrid(list){
  const g=_('grid');
  if(!list.length){g.innerHTML=`<div class="empty"><div class="empty-ico">üß≥</div><h3 style="font-size:1.1rem;margin-bottom:5px">Nincs tal√°lat</h3><p style="font-size:.84rem">Pr√≥b√°lj m√°s felt√©telt, vagy adj hozz√° √∫j term√©ket!</p></div>`;return;}
  g.innerHTML=list.map(card).join('');
}

function imgs(p){
  if(p.images?.length)return p.images.filter(i=>i&&i!=='__img__');
  if(p.image&&p.image!=='__img__')return[p.image];
  return[];
}

function card(p){
  const lp=latPr(p),pch=prCh(p),im=imgs(p),li=im.length?im[im.length-1]:null,avg=avgR(p);
  const pc=Array.isArray(p.countries)?p.countries:(p.country?[p.country]:[]);
  const ps=Array.isArray(p.shops)?p.shops:(p.shop?[p.shop]:[]);
  const aS=new Set(ps),aC=new Set(pc);
  (p.priceHistory||[]).forEach(h=>{if(h.shop)aS.add(h.shop);if(h.country)aC.add(h.country);});
  const pills=[...aS].map(s=>`<span class="pill">üè™ ${esc(s)}</span>`).join('')+[...aC].map(c=>`<span class="pill">üåç ${esc(cs(c))}</span>`).join('');
  const sh=[...(p.priceHistory||[])].sort((a,b)=>(b.date||'')>(a.date||'')?1:-1);
  const hist=sh.length>1?`<details style="margin-top:4px" onclick="event.stopPropagation()">
    <summary>üìä √Årt√∂rt√©net (${sh.length})</summary>
    <div class="ph" style="margin-top:4px">
      ${sh.slice(0,5).map(h=>{const x=[h.country?cs(h.country):'',h.shop?h.shop:'',h.note?h.note:''].filter(Boolean).join(' ¬∑ ');return`<div class="ph-row"><span class="ph-d">${h.date?new Date(h.date).toLocaleDateString('hu-HU',{month:'short',day:'numeric'}):'‚Äì'}</span><span class="ph-v">${h.amount} ${h.currency||p.currency}</span>${x?`<span class="ph-x">${esc(x)}</span>`:'<span class="ph-x"></span>'}</div>`;}).join('')}
      ${sh.length>5?`<div style="text-align:center;padding:5px;color:var(--muted);font-size:.73rem">+ m√©g ${sh.length-5} bejegyz√©s</div>`:''}
    </div></details>`:'';
  const admin=isAdmin?`<div class="c-foot"><button class="bi bsm" onclick="openEdit('${p.id}')">‚úèÔ∏è</button><button class="btn br bsm" onclick="delProd('${p.id}')">T√∂rl√©s</button></div>`:'';
  return`<div class="card" data-id="${p.id}">
    <div class="c-img-wrap">
      ${li?`<img class="c-img c-ic" src="${li}" alt="${esc(p.name)}" loading="lazy" data-pid="${p.id}">`:`<div class="c-ph" data-pid="${p.id}">üõçÔ∏è</div>`}
      ${p.category?`<span class="c-cat">${esc(p.category)}</span>`:''}
      ${im.length>1?`<div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.7);color:#fff;padding:3px 8px;border-radius:12px;font-size:.69rem;pointer-events:none">üì∑ ${im.length}</div>`:''}
      ${avg>0?`<div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,.7);color:#fff;padding:3px 8px;border-radius:12px;font-size:.77rem;display:flex;align-items:center;gap:4px"><span style="color:var(--star)">${'‚òÖ'.repeat(Math.round(avg))}</span> <span style="color:rgba(255,255,255,.8)">${avg.toFixed(1)}</span></div>`:''}
    </div>
    <div class="c-body" onclick="openView('${p.id}')">
      <div class="c-name">${esc(p.name)}</div>
      ${p.desc?`<div class="c-desc">${esc(p.desc)}</div>`:''}
      <div class="c-meta">${pills}</div>
      <div class="c-pr-row"><div class="c-pr">${lp.amount?lp.amount+' '+(lp.currency||''):'‚Äì'}</div>${pch}</div>
      ${hist}
    </div>${admin}</div>`;
}

function latPr(p){
  if(p.priceHistory?.length){const s=[...p.priceHistory].filter(h=>h.amount).sort((a,b)=>(b.date||'')>(a.date||'')?1:-1);if(s.length)return s[0];}
  return{amount:p.price,currency:p.currency,note:p.priceNote};
}
function prCh(p){
  if(!p.priceHistory||p.priceHistory.length<2)return'';
  const s=[...p.priceHistory].filter(h=>h.amount&&h.currency).sort((a,b)=>(b.date||'')>(a.date||'')?1:-1);
  if(s.length<2)return'';
  const la=s[0],pr=s.slice(1).find(h=>h.currency===la.currency);if(!pr)return'';
  const d=la.amount-pr.amount;if(Math.abs(d)<.001)return'';
  const pct=((d/pr.amount)*100).toFixed(1);
  return d>0?`<span class="pch pup">üìà +${pct}%</span>`:`<span class="pch pdn">üìâ ${pct}%</span>`;
}
function avgR(p){const a=[...(p.reviews||[]).map(r=>r.rating).filter(r=>r>0)];if(p.rating>0)a.push(p.rating);if(!a.length)return 0;return a.reduce((a,b)=>a+b,0)/a.length;}

// event delegation
_('grid').addEventListener('click',e=>{
  const ic=e.target.closest('.c-ic');
  if(ic){e.stopPropagation();const p=prods.find(x=>x.id===ic.dataset.pid);if(!p)return;const im=imgs(p);const l=im.length?im[im.length-1]:null;if(l)openLB(l);return;}
  const ph=e.target.closest('.c-ph');if(ph&&ph.dataset.pid)openView(ph.dataset.pid);
});
_('mViewB').addEventListener('click',e=>{const ic=e.target.closest('.g-ic');if(ic){e.stopPropagation();if(ic.src)openLB(ic.src);}});

// ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ
function adminClick(){if(isAdmin){isAdmin=false;sessionStorage.removeItem('isAdmin');updAdmin();return;}openM('mLogin');}
function doLogin(){const pw=_('aPw').value;if(pw===ADMIN_PW){isAdmin=true;sessionStorage.setItem('isAdmin','true');closeM('mLogin');_('aPw').value='';_('aErr').style.display='none';updAdmin();toast('Admin m√≥d akt√≠v! ‚úì');}else _('aErr').style.display='block';}
  function updAdmin() {
    const bar = _('adminBar');
    if (isAdmin) {
      bar.classList.add('on');
    } else {
      bar.classList.remove('on');
    }
    filter();
  }
function updShSt(){
  const el=_('shSt');if(!el)return;
  if(shUrl){el.style.cssText='background:#e6f5ec;color:var(--green)';el.innerHTML='‚úì Google Sheets √∂sszek√∂tve';_('btnSheets').style.background='rgba(22,163,74,.3)';}
  else{el.style.cssText='background:#fef3c7;color:#92400e';el.innerHTML='‚ö† Nincs Sheets kapcsolat';_('btnSheets').style.background='rgba(255,255,255,.15)';}
}
async function saveSh(){
  const u=_('shUrl').value.trim();
  if(!u||!u.includes('script.google.com')){toast('√ârv√©nytelen URL','err');return;}
  setLd(true,'Kapcsolat tesztel√©se...');
  try{
    const d=await(await fetch(`${u}?action=getAll`)).json();
    if(d.ok!==undefined){
      shUrl=u;localStorage.setItem('sheetsApiUrl',u);
      if(!d.products&&prods.length>0){await shWrite({action:'setAll',products:JSON.stringify(prods),categories:JSON.stringify(cats),currencies:JSON.stringify(currs),shopOrder:JSON.stringify(shpOrd)});toast('Kapcsol√≥dva! Adatok felt√∂ltve.');}
      else{if(d.products)try{prods=JSON.parse(d.products);}catch(e){}if(d.categories)try{cats=JSON.parse(d.categories);}catch(e){}if(d.currencies)try{currs=JSON.parse(d.currencies);}catch(e){}if(d.shopOrder)try{shpOrd=JSON.parse(d.shopOrder);}catch(e){}renderAll();toast('Kapcsol√≥dva! Sheets adatok bet√∂ltve.');}
      updShSt();closeM('mSheets');
    }else toast('Szerver hiba','err');
  }catch(e){toast('Kapcsol√≥d√°si hiba','err');}
  setLd(false);
}
function clearSh(){shUrl='';localStorage.removeItem('sheetsApiUrl');_('shUrl').value='';updShSt();toast('Kapcsolat t√∂r√∂lve');closeM('mSheets');}

// ‚îÄ‚îÄ PRODUCT ADD/EDIT ‚îÄ‚îÄ
function openAddProd(){
  editId=null;imgPend=null;_('mProdT').textContent='√öj term√©k';
  ['fN','fD','fP','fPN','fNt','fUp'].forEach(id=>_(id).value='');
  _('fCatS').value='';_('fCurS').value='';_('fDt').value=new Date().toISOString().split('T')[0];
  setR(0);clrTags();_('iuPrev').style.display='none';_('iuIco').style.display='block';_('iuTxt').style.display='block';
  openM('mProd');
}
function openEdit(id){
  if(!isAdmin)return;
  const p=prods.find(x=>x.id===id);if(!p)return;
  editId=id;imgPend=null;_('mProdT').textContent='Term√©k szerkeszt√©se';
  _('fN').value=p.name||'';_('fD').value=p.desc||'';_('fCatS').value=p.category||'';
  _('fDt').value=p.date||'';_('fNt').value=p.note||'';_('fUp').value=p.uploader||'';
  const o=p.priceHistory?.length?p.priceHistory[0]:{};
  _('fP').value=o.amount||p.price||'';_('fCurS').value=o.currency||p.currency||'';_('fPN').value=o.note||p.priceNote||'';
  setR(p.rating||0);
  const cts=new Set(Array.isArray(p.countries)?p.countries:(p.country?[p.country]:[]));
  const shs=new Set(Array.isArray(p.shops)?p.shops:(p.shop?[p.shop]:[]));
  (p.priceHistory||[]).forEach(h=>{if(h.country)cts.add(h.country);if(h.shop)shs.add(h.shop);});
  setTags([...cts],[...shs]);
  const im=imgs(p),li=im.length?im[im.length-1]:null;
  if(li){_('iuPrev').src=li;_('iuPrev').style.display='block';_('iuIco').style.display='none';_('iuTxt').style.display='none';}
  else{_('iuPrev').style.display='none';_('iuIco').style.display='block';_('iuTxt').style.display='block';}
  openM('mProd');
}

  async function fileToWebP(file, { maxWidth = 1200, maxHeight = 1200, quality = 0.8 } = {}) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = e => img.src = e.target.result;
      reader.onerror = reject;
      img.onload = () => {
        let { width, height } = img;
        const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
        width *= ratio; height *= ratio;
        const canvas = document.createElement('canvas');
        canvas.width = width; canvas.height = height;
        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
        resolve(canvas.toDataURL('image/webp', quality));
      };
      reader.readAsDataURL(file);
    });
  }

function handleImg(e){
  const f=e.target.files[0];if(!f)return;_('iuTxt').textContent='T√∂m√∂r√≠t√©s...';
  fileToWebP(f, { quality: 0.85 }).then(c=>{imgPend=c;_('iuPrev').src=c;_('iuPrev').style.display='block';_('iuIco').style.display='none';_('iuTxt').style.display='none';});
}
async function saveProd(){
  const n=_('fN').value.trim();if(!n){toast('A term√©k neve k√∂telez≈ë!','err');return;}
  if(!editId&&prods.some(p=>p.name.toLowerCase()===n.toLowerCase())){toast('Ilyen nev≈± term√©k m√°r l√©tezik!','err');return;}
  const ci=_('fCntI').value.trim(),si=_('fShpI').value.trim();if(ci)addTag('c',ci);if(si)addTag('s',si);
  const pr=parseFloat(_('fP').value)||0,cu=_('fCurS').value;
  if(pr>0&&!cu){toast('Add meg a p√©nznemet!','err');return;}
  const dt=_('fDt').value||new Date().toISOString().split('T')[0];
  const pe=pr>0?{amount:pr,currency:cu,note:_('fPN').value.trim(),date:dt,shop:fShps[0]||'',country:fCnts[0]||''}:null;
  const hasImg=!!imgPend;
  if(editId){
    const i=prods.findIndex(x=>x.id===editId);
    if(i>-1){
      const ex=prods[i];let ph=ex.priceHistory||[];
      if(pe){if(!ph.length)ph=[pe];else ph[0]={...ph[0],amount:pr,currency:cu,note:_('fPN').value.trim()};}
      const ni=imgPend?[...imgs(ex),imgPend]:imgs(ex);
      prods[i]={...ex,name:n,desc:_('fD').value.trim(),category:_('fCatS').value,countries:[...fCnts],shops:[...fShps],country:fCnts[0]||'',shop:fShps[0]||'',date:dt,note:_('fNt').value.trim(),uploader:_('fUp').value.trim(),price:ph.length?ph[0].amount:0,currency:ph.length?ph[0].currency:cu,priceNote:ph.length?ph[0].note:_('fPN').value.trim(),priceHistory:ph,rating:rat,images:ni,image:null};
    }
    toast('Term√©k friss√≠tve! ‚úì');
  }else{
    prods.unshift({id:'p'+Date.now(),name:n,desc:_('fD').value.trim(),category:_('fCatS').value,countries:[...fCnts],shops:[...fShps],country:fCnts[0]||'',shop:fShps[0]||'',date:dt,note:_('fNt').value.trim(),uploader:_('fUp').value.trim(),price:pr,currency:cu,priceNote:_('fPN').value.trim(),priceHistory:pe?[pe]:[],rating:rat,images:imgPend?[imgPend]:[],image:null,reviews:[],createdAt:new Date().toISOString()});
    toast('Term√©k hozz√°adva! ‚úì');
  }
  await save(!hasImg);renderAll();closeM('mProd');
}
function delProd(id){if(!isAdmin||!confirm('Biztosan t√∂rl√∂d?'))return;prods=prods.filter(p=>p.id!==id);save();delImgSh(id);filter();popDL();toast('Term√©k t√∂r√∂lve.');}

  async function delImg(pid, di, e) {
    e.stopPropagation(); if (!isAdmin || !confirm('Biztosan t√∂rl√∂d a k√©pet?')) return;
    const p = prods.find(x => x.id === pid); if (!p) return;
    const arr = imgs(p), rm = arr[arr.length - 1 - parseInt(di)]; if (!rm) return;
    if (p.images) p.images = p.images.filter(i => i !== rm); if (p.image === rm) p.image = null;
    await save(); filter(); openView(pid); toast('K√©p t√∂r√∂lve!');
  }

// ‚îÄ‚îÄ PRICE ‚îÄ‚îÄ
function openPr(id){
  prId=id;const p=prods.find(x=>x.id===id);if(!p)return;
  const lp=latPr(p);_('pP').value='';_('pC').value=lp.currency||'';_('pNote').value='';_('pCnt').value='';_('pShp').value='';
  _('pDt').value=new Date().toISOString().split('T')[0];openM('mPrice');
}
async function savePr(){
  const p=prods.find(x=>x.id===prId);if(!p)return;
  const a=parseFloat(_('pP').value);if(isNaN(a)||a<=0){toast('Add meg az √∫j √°rat!','err');return;}
  const cu=_('pC').value;if(!cu){toast('V√°lassz p√©nznemet!','err');return;}
  if(!p.priceHistory)p.priceHistory=p.price>0?[{amount:p.price,currency:p.currency,note:p.priceNote,date:p.date}]:[];
  p.priceHistory.push({amount:a,currency:cu,note:_('pNote').value.trim(),country:_('pCnt').value.trim(),shop:_('pShp').value.trim(),date:_('pDt').value});
  p.price=a;p.currency=cu;
  await saveMeta();closeM('mPrice');filter();toast('√År friss√≠tve! üí∞');
}

// ‚îÄ‚îÄ VIEW ‚îÄ‚îÄ
function openView(id){
  const p=prods.find(x=>x.id===id);if(!p)return;
  revPid=id;_('mViewT').textContent=p.name;
  const avg=avgR(p),revs=[...(p.reviews||[])];
  if(p.rating>0)revs.unshift({name:p.uploader||'Felt√∂lt≈ë',rating:p.rating,note:p.note,date:p.date});
  const revHtml = revs.length ? revs.map(r => `<div style="padding:7px 0;border-bottom:1px solid var(--bd)"><div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap"><span style="font-weight:600;font-size:.82rem">üë§ ${esc(r.name || 'N√©vtelen')}</span>${r.date ? `<span style="font-size:.69rem;color:var(--muted)">‚Ä¢ ${new Date(r.date).toLocaleDateString('hu-HU', { month: 'short', day: 'numeric' })}</span>` : ''}<span style="color:var(--star);font-size:.82rem;margin-left:auto">${'‚òÖ'.repeat(r.rating || 0)}${'‚òÜ'.repeat(5 - (r.rating || 0))}</span></div>${r.note ? `<div style="font-size:.78rem;color:var(--muted);margin-top:4px;font-style:italic">"${esc(r.note)}"</div>` : ''}</div>`).join('')
    :'<div style="color:var(--muted);font-size:.81rem">M√©g nincs √©rt√©kel√©s.</div>';
  const lp=latPr(p);
  const pc=Array.isArray(p.countries)?p.countries:(p.country?[p.country]:[]);
  const ps=Array.isArray(p.shops)?p.shops:(p.shop?[p.shop]:[]);
  const aS=new Set(ps),aC=new Set(pc);(p.priceHistory||[]).forEach(h=>{if(h.shop)aS.add(h.shop);if(h.country)aC.add(h.country);});
  const pills=[...aS].map(s=>`<span class="pill">üè™ ${esc(s)}</span>`).join('')+[...aC].map(c=>`<span class="pill">üåç ${esc(cs(c))}</span>`).join('');
  const im=imgs(p).reverse();
  const gal=im.length?`<div class="gallery" data-id="${p.id}" style="height:270px;border-radius:10px;margin-bottom:8px;overflow:hidden;background:var(--cream);position:relative;flex-shrink:0">
    <div class="g-track">${im.map((img,i)=>`<div class="g-slide"><img src="${img}" style="width:100%;height:270px;object-fit:cover;cursor:zoom-in" class="g-ic" data-i="${i}" data-pid="${p.id}">${isAdmin?`<button class="btn br bsm" style="position:absolute;top:8px;right:8px;z-index:10" onclick="delImg('${p.id}','${i}',event)">üóëÔ∏è</button>`:''}</div>`).join('')}</div>
    ${im.length>1?`<div class="g-dots">${im.map((_,i)=>`<div class="g-dot${i===0?' on':''}"></div>`).join('')}</div><button onclick="gNav('${p.id}','p',event)" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.5);color:#fff;border:none;border-radius:50%;width:34px;height:34px;font-size:1.2rem;cursor:pointer;z-index:5;display:flex;align-items:center;justify-content:center">‚Äπ</button><button onclick="gNav('${p.id}','n',event)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.5);color:#fff;border:none;border-radius:50%;width:34px;height:34px;font-size:1.2rem;cursor:pointer;z-index:5;display:flex;align-items:center;justify-content:center">‚Ä∫</button>`:''}
  </div>`:'';
  const sh=[...( p.priceHistory||[])].sort((a,b)=>(b.date||'')>(a.date||'')?1:-1);
  _('mViewB').innerHTML=`${gal}
    <div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px">${p.category?`<span class="pill">üìÇ ${esc(p.category)}</span>`:''}${pills}${p.date?`<span class="pill">üìÖ ${new Date(p.date).toLocaleDateString('hu-HU')}</span>`:''}</div>
    ${p.desc?`<div style="font-size:.87rem;color:var(--muted);margin-bottom:8px">${esc(p.desc)}</div>`:''}
    <div style="font-size:1.25rem;font-weight:800;margin-bottom:4px">${lp.amount?lp.amount+' '+(lp.currency||''):'‚Äì'} ${prCh(p)}</div>
    ${sh.length>1?`<div class="ph" style="margin-bottom:8px"><div class="ph-title">√Årt√∂rt√©net</div>${sh.map(h=>{const x=[h.country?cs(h.country):'',h.shop?h.shop:'',h.note?h.note:''].filter(Boolean).join(' ¬∑ ');return`<div class="ph-det"><span class="ph-d">${h.date?new Date(h.date).toLocaleDateString('hu-HU'):'‚Äì'}</span><span class="ph-v">${h.amount} ${h.currency||''}</span><span class="ph-x">${esc(x)}</span></div>`;}).join('')}</div>`:''}
    <div style="margin:10px 0 5px;font-weight:600;font-size:.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:.4px">√ârt√©kel√©sek (${revs.length})</div>
    ${avg>0?`<div style="font-size:.95rem;color:var(--star);margin-bottom:6px">${'‚òÖ'.repeat(Math.round(avg))}${'‚òÜ'.repeat(5-Math.round(avg))} ${avg.toFixed(1)}</div>`:''}
    ${revHtml}`;
  _('mViewF').innerHTML = `
    <button class="btn bp" onclick="closeM('mView');openQImg('${id}')">üì∑ K√©p</button>
    <button class="btn bp" onclick="closeM('mView');openRevM('${id}')">‚úç √ârt√©kel√©s</button>
    <button class="btn bp" onclick="closeM('mView');openPr('${id}')">üí∞ √År</button>
    <button class="btn bg" onclick="closeM('mView')">Bez√°r</button>`;
  openM('mView');setTimeout(initGallery,80);
}

function gNav(id,dir,e){
  e.stopPropagation();const g=document.querySelector(`.gallery[data-id="${id}"]`);if(!g)return;
  const sl=g.querySelectorAll('.g-slide'),ci=g._ci?g._ci():0;
  const n=dir==='p'?(ci>0?ci-1:sl.length-1):(ci<sl.length-1?ci+1:0);
  if(g._go)g._go(n);
}

// arrow keys in view modal
document.addEventListener('keydown',e=>{
  const m=_('mView');if(!m?.classList.contains('on'))return;
  const g=m.querySelector('.gallery');if(!g)return;
  const pid=g.getAttribute('data-id');if(!pid)return;
  if(e.key==='ArrowLeft'){e.preventDefault();gNav(pid,'p',e);}
  else if(e.key==='ArrowRight'){e.preventDefault();gNav(pid,'n',e);}
});

// ‚îÄ‚îÄ QUICK IMAGE ‚îÄ‚îÄ
function openQImg(pid){qImgPid=pid;qImgB64=null;_('qImg').value='';_('qPrvA').style.display='none';_('qSave').disabled=true;openM('mImg');}
function handleQImg(e){const f=e.target.files[0];if(!f)return; fileToWebP(f, { quality: 0.85 }).then(c=>{qImgB64=c;_('qPrv').src=c;_('qPrvA').style.display='block';_('qSave').disabled=false;});}
async function saveQImg(){
  if(!qImgPid||!qImgB64)return;const p=prods.find(x=>x.id===qImgPid);if(!p)return;
  if(!p.images)p.images=[];p.images.push(qImgB64);p.image=null;
  await save();closeM('mImg');toast('K√©p hozz√°adva! ‚úì');filter();
}

// ‚îÄ‚îÄ REVIEWS ‚îÄ‚îÄ
function openRevM(id){revPid=id;_('rN').value='';_('rNote').value='';setRR(0);openM('mRev');}
async function saveRev(){
  const n=_('rN').value.trim();if(!n){toast('√çrd be a neved!','err');return;}
  const p=prods.find(x=>x.id===revPid);if(!p)return;
  if(!p.reviews)p.reviews=[];
  p.reviews.push({name:n,note:_('rNote').value.trim(),rating:ratR,date:new Date().toISOString().split('T')[0],id:'r'+Date.now()});
  await saveMeta();closeM('mRev');filter();toast('√ârt√©kel√©s hozz√°adva! ‚úì');
}

// ‚îÄ‚îÄ CATS ‚îÄ‚îÄ
let dragSrc=null;
function makeDrag(cont,onR){
  cont.querySelectorAll('.ci[draggable]').forEach(it=>{
    it.addEventListener('dragstart',e=>{dragSrc=it;it.classList.add('drag');e.dataTransfer.effectAllowed='move';});
    it.addEventListener('dragend',()=>{it.classList.remove('drag');cont.querySelectorAll('.ci').forEach(i=>i.classList.remove('do'));});
    it.addEventListener('dragover',e=>{e.preventDefault();if(it!==dragSrc){cont.querySelectorAll('.ci').forEach(i=>i.classList.remove('do'));it.classList.add('do');}});
    it.addEventListener('drop',e=>{e.preventDefault();if(!dragSrc||dragSrc===it)return;it.classList.remove('do');const its=[...cont.querySelectorAll('.ci[draggable]')];if(its.indexOf(dragSrc)<its.indexOf(it))it.after(dragSrc);else it.before(dragSrc);onR([...cont.querySelectorAll('.ci[draggable]')].map(el=>el.dataset.v));});
  });
}
function renderCatList(){
  const el=_('catList');
  el.innerHTML=cats.map(c=>`<div class="ci" draggable="true" data-v="${esc(c)}"><span class="dh">‚†ø</span><span class="cn">üìÇ ${esc(c)}</span><button class="btn br bsm" onclick="rmCat('${esc(c)}')">‚úï</button></div>`).join('');
  makeDrag(el,async o=>{cats=o;await save();popCatSel();});
}
async function addCat(){const v=_('newCat').value.trim();if(!v||cats.includes(v))return;cats.push(v);_('newCat').value='';await save(true);renderCatList();popCatSel();toast('Kateg√≥ria hozz√°adva!');}
async function rmCat(c){cats=cats.filter(x=>x!==c);await save(true);renderCatList();popCatSel();}

function renderCurrList(){
  _('currList').innerHTML=currs.map(c=>`<div class="ci"><span class="cn">üí± <strong>${esc(c.code)}</strong> ‚Äì ${esc(c.name)}</span><button class="btn br bsm" onclick="rmCurr('${esc(c.code)}')">‚úï</button></div>`).join('');
}
async function addCurr(){
  const co=_('nCC').value.trim().toUpperCase(),n=_('nCN').value.trim();
  if(!co||!n){toast('Add meg a k√≥dot √©s nevet!','err');return;}
  if(currs.some(c=>c.code===co)){toast('M√°r l√©tezik!','err');return;}
  currs.push({code:co,name:n});_('nCC').value='';_('nCN').value='';
  await save(true);renderCurrList();popCurrSel();toast('P√©nznem hozz√°adva!');
}
async function rmCurr(co){currs=currs.filter(c=>c.code!==co);await save(true);renderCurrList();popCurrSel();}

function uCnts(){return[...new Set(prods.flatMap(p=>{const f=Array.isArray(p.countries)?p.countries:(p.country?[p.country]:[]);return[...f,...(p.priceHistory||[]).map(h=>h.country).filter(Boolean)];}))].sort();}
function uShps(){const a=[...new Set(prods.flatMap(p=>{const f=Array.isArray(p.shops)?p.shops:(p.shop?[p.shop]:[]);return[...f,...(p.priceHistory||[]).map(h=>h.shop).filter(Boolean)];}))];return[...shpOrd.filter(s=>a.includes(s)),...a.filter(s=>!shpOrd.includes(s)).sort()];}
function popDL(){_('cntList').innerHTML=uCnts().map(c=>`<option value="${esc(c)}">`).join('');_('shpList').innerHTML=uShps().map(s=>`<option value="${esc(s)}">`).join('');}

function renderCntList(){
  const cnts=uCnts(),el=_('cntList2')||(_('mCnts').querySelector('.cl'));
  if(!cnts.length){el.innerHTML='<div style="color:var(--muted);font-size:.84rem">M√©g nincs r√∂gz√≠tett orsz√°g.</div>';return;}
  el.innerHTML=cnts.map(c=>`<div class="ci"><span class="cn">üåç ${esc(c)}</span><button class="bi bsm" onclick="editCnt('${esc(c)}')">‚úèÔ∏è</button></div>`).join('');
}
function renderShpList(){
  const shps=uShps(),el=_('shpList2');
  if(!shps.length){el.innerHTML='<div style="color:var(--muted);font-size:.84rem">M√©g nincs r√∂gz√≠tett bolt.</div>';return;}
  el.innerHTML=shps.map(s=>`<div class="ci" draggable="true" data-v="${esc(s)}"><span class="dh">‚†ø</span><span class="cn">üè™ ${esc(s)}</span><button class="bi bsm" onclick="editShp('${esc(s)}')">‚úèÔ∏è</button></div>`).join('');
  makeDrag(el,async o=>{shpOrd=o;await save();popDL();updFO();});
}
function editCnt(o){const n=prompt('√Åtnevez√©s:',o);if(!n||n.trim()===o)return;const t=n.trim();prods.forEach(p=>{if(p.country===o)p.country=t;if(Array.isArray(p.countries))p.countries=p.countries.map(c=>c===o?t:c);(p.priceHistory||[]).forEach(h=>{if(h.country===o)h.country=t;});});save();renderCntList();filter();popDL();toast('√Åtnevezve: '+t);}
function editShp(o){const n=prompt('√Åtnevez√©s:',o);if(!n||n.trim()===o)return;const t=n.trim();prods.forEach(p=>{if(p.shop===o)p.shop=t;if(Array.isArray(p.shops))p.shops=p.shops.map(s=>s===o?t:s);(p.priceHistory||[]).forEach(h=>{if(h.shop===o)h.shop=t;});});shpOrd=shpOrd.map(s=>s===o?t:s);save();renderShpList();filter();popDL();toast('√Åtnevezve: '+t);}

// ‚îÄ‚îÄ RATINGS ‚îÄ‚îÄ
const RL=['','Gyenge','Megfelel≈ë','J√≥','Nagyon j√≥','Kiv√°l√≥'];
function setR(n){rat=n;updStars('#sp',n);const l=_('rLbl');if(l)l.textContent=n>0?RL[n]+` (${n}/5)`:'Koppints egy csillagra';}
function setRR(n){ratR=n;updStars('#sp2',n);const l=_('rLbl2');if(l)l.textContent=n>0?RL[n]+` (${n}/5)`:'Koppints egy csillagra';}
function updStars(sel,n){const bs=document.querySelectorAll(sel+' .sb');bs.forEach((b,i)=>{b.classList.toggle('on',i<n);b.onmouseenter=()=>bs.forEach((bb,j)=>bb.style.color=j<=i?'var(--star)':'#d0d0d0');b.onmouseleave=()=>bs.forEach(bb=>bb.style.color='');});}

// ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ
function openM(id){_(id).classList.add('on');document.body.style.overflow='hidden';}
function closeM(id){_(id).classList.remove('on');document.body.style.overflow='';}
function dirty(){return!!(  _('fN').value.trim()||_('fD').value.trim()||_('fP').value.trim()||fCnts.length||fShps.length||imgPend);}
document.querySelectorAll('.ov').forEach(o=>o.addEventListener('click',e=>{if(e.target!==o)return;if(o.id==='mProd'&&dirty()){if(!confirm('Biztosan ki akarsz l√©pni?'))return;}closeM(o.id);}));

// search toggle
function toggleSearch(){const s=_('searchBar');s.classList.toggle('open');if(s.classList.contains('open'))_('sInp').focus();}

// clear filters
function clearF(){['sInp','fCat','fCnt','fShp','fCur'].forEach(id=>_(id).value='');filter();}
function updCF(){const h=!!(_('sInp').value||_('fCat').value||_('fCnt').value||_('fShp').value||_('fCur').value);_('btnCF').style.display=h?'inline-flex':'none';}

// export
function exportCSV(){
  const hd=['N√©v','Le√≠r√°s','Kateg√≥ria','Orsz√°g','Bolt','D√°tum','√År','P√©nznem','√ârt√©kel√©s','Megjegyz√©s'];
  const rows=prods.map(p=>{const lp=latPr(p),pc=Array.isArray(p.countries)?p.countries:(p.country?[p.country]:[]),ps=Array.isArray(p.shops)?p.shops:(p.shop?[p.shop]:[]);return[p.name,p.desc||'',p.category||'',pc.join(', '),ps.join(', '),p.date||'',lp.amount||'',lp.currency||'',avgR(p).toFixed(1),p.note||''].map(v=>'"'+String(v).replace(/"/g,'""')+'"');});
  const csv=[hd.map(h=>'"'+h+'"').join(','),...rows.map(r=>r.join(','))].join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'}));a.download='kulfoldi-vasarlasok.csv';a.click();toast('CSV export√°lva! ‚úì');
}

  // lightbox
  let scrollY = 0;
  function openLB(src) {
    scrollY = window.scrollY;
    _('lbImg').src = src;
    _('lb').classList.add('on');
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollY}px`;
    document.body.style.width = '100%';
  }
  function closeLB() {
    _('lb').classList.remove('on');
    _('lbImg').src = '';
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    if (!document.querySelector('.ov.on')) document.body.style.overflow = '';
    window.scrollTo(0, scrollY);
  }

// toast
let tT;
function toast(msg,t='ok'){const el=_('toast');el.textContent=msg;el.className=`toast ${t} on`;clearTimeout(tT);tT=setTimeout(()=>el.classList.remove('on'),2800);}

// country codes
const CC={'Magyarorsz√°g':'HU','Ausztria':'AT','N√©metorsz√°g':'DE','Olaszorsz√°g':'IT','Franciaorsz√°g':'FR','Spanyolorsz√°g':'ES','Csehorsz√°g':'CZ','Szlov√°kia':'SK','Lengyelorsz√°g':'PL','Horv√°torsz√°g':'HR','Szerbia':'RS','Rom√°nia':'RO','Bulg√°ria':'BG','G√∂r√∂gorsz√°g':'GR','T√∂r√∂korsz√°g':'TR','Egyes√ºlt Kir√°lys√°g':'GB','Hollandia':'NL','Belgium':'BE','Sv√°jc':'CH','Sv√©dorsz√°g':'SE','Norv√©gia':'NO','D√°nia':'DK','Finnorsz√°g':'FI','Portug√°lia':'PT','Egyes√ºlt √Ållamok':'US','Jap√°n':'JP','K√≠na':'CN','Thaif√∂ld':'TH','Vietnam':'VN','India':'IN','√âsztorsz√°g':'EE','Lettorsz√°g':'LV','Litv√°nia':'LT','Szlov√©nia':'SI','Alb√°nia':'AL','Montenegr√≥':'ME'};
function cs(n){return CC[n]||n||'';}
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// ESC key
document.addEventListener('keydown',e=>{
  if(e.key!=='Escape')return;
  if(_('lb').classList.contains('on')){closeLB();return;}
  const a=[...document.querySelectorAll('.ov.on')];if(!a.length)return;
  const top=a[a.length-1];if(top.id==='mProd'&&dirty()){if(!confirm('Biztosan ki akarsz l√©pni?'))return;}
  closeM(top.id);
});

  if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }

init();
</script>
</body>
</html>
